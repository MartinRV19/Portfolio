---
title: Venta departamentos properati
format:
  html:
    code-fold: show # true: oculta el codigo em celda
    toc: true      # Agrega la tabla de contenidos
    toc-title: "Contenido" # Cambia el título de tabla de contenidos
    theme: cosmo
    embed-resources: true

jupyter: python3
---

```{python}
import pandas as pd
import matplotlib.pyplot as plt
import plotly.express as px
import os
import seaborn as sns
import geopandas
import plotly.io as pio
import numpy as np
from scipy.stats import iqr
pio.renderers.default = 'notebook_connected'
```

```{python}
# datos scrapeados del sitio Properati 
# notebook scraping = https://github.com/MartinRV19/departamentos-CABA-venta
cwd = os.getcwd()
df = pd.read_csv(cwd + '\\departamentos_venta_2022_properati_modified.csv', index_col=None, header=0)
```

# EDA

```{python}
df.head()
```

```{python}
df.info()
```

**3407 departamentos**

```{python}
df.describe()

```

**El 75% de los departamentos valen menos de USD 230.000**

**Hay un rango de departamentos entre USD 375 a USD 11.229 el m2**  	

```{python}
p99 = np.percentile(df['Precio(USD)'],99)
print(int(p99))
```

**El 99% de los departamentos valen menos de aprox. USD 1.2M**

```{python}
fig, ax = plt.subplots(figsize=(6,12))

sns.boxplot(y="Precio(USD)", data=df,color='orange')
ax.set_ylabel('Precio en millones de dólares', size=12)

plt.show()
```

```{python}
IQR = iqr(df['Precio(USD)']) # rango intercuartil 
print(IQR)
```

```{python}
# rango superior "extremo" para detectar outliers = percentil 75 + 3 * rango intercuartil
p75 = np.percentile(df['Precio(USD)'],75)
rango_superior = p75 + 3 * IQR
cantidad_outliers = len(df[df['Precio(USD)'] >= rango_superior])

print(f'Rango Superior: {rango_superior}')
print(f'Cantidad de outliers: {cantidad_outliers}')
print(f'Proporción de outliers sobre el total: {round(cantidad_outliers/len(df),2)}')
```

# Visualizaciones

```{python}
fig, ax = plt.subplots(figsize=(14,6))

ax = sns.histplot(data=df, x='Precio(USD)',ax=ax,color='orange')
ax.set_title('Distribución Precio departamentos',{'fontsize': 16},pad=15)
ax.set_xlabel('Precio en millones de dólares', size=12)
ax.set_ylabel('Frecuencia', size=12)

plt.show()
```

```{python}
fig, ax = plt.subplots(figsize=(14,6))

datos_sin_outliers = df[df['Precio(USD)'] <= rango_superior]

ax = sns.histplot(data=datos_sin_outliers, x='Precio(USD)',ax=ax,color='orange')
ax.set_title(f'Distribución Precio departamentos\n(Sin valores superiores a USD {int(rango_superior)})',{'fontsize': 16},pad=15)
ax.set_xlabel('Precio', size=12)
ax.set_ylabel('Frecuencia', size=12)

plt.show()
```

```{python}
top_10_barrio_porcentaje = df.value_counts('BARRIO',normalize=True).rename('porcentaje').mul(100).reset_index().sort_values('porcentaje',ascending=False)[0:10]

fig, ax = plt.subplots(figsize=(14,6))

ax = sns.barplot(x="porcentaje", y="BARRIO", data=top_10_barrio_porcentaje,color='orange')

ax.set_title('Top 10 barrios según cantidad de publicaciones',{'fontsize': 16},pad=15)
ax.set_xlabel('Porcentaje sobre el total de publicaciones', size=12)
ax.set_ylabel('')

plt.show()
```

# Mapa

```{python}
url = 'https://cdn.buenosaires.gob.ar/datosabiertos/datasets/barrios/barrios.geojson'
geodf = geopandas.read_file(url)
geodf = geodf[['BARRIO','geometry']]
geodf.set_index('BARRIO',inplace=True)
geodf.head()
```

```{python}
geodf.index.sort_values()
```

```{python}
geodf.index[geodf.index.isin(df['BARRIO']) == False].unique() 
```

```{python}
df.BARRIO[df.BARRIO.isin(geodf.index) == False].unique()
```

```{python}
# reemplazo valores en df
df.BARRIO.replace(['VILLA GENERAL MITRE','POMPEYA'],['VILLA GRAL. MITRE','NUEVA POMPEYA'],inplace=True)
```

```{python}
geodf.index[geodf.index.isin(df['BARRIO']) == False].unique() 
```

```{python}
print(df.BARRIO[df.BARRIO.isin(geodf.index) == False].unique())
# no se considera los 160 registros con nombre de barrios no oficiales
print(len(df[df.BARRIO.isin(geodf.index) == False]))
```

```{python}
# tabla con valores promedio por barrio
tabla_valores_promedio = df.groupby('BARRIO').mean()[['Precio(USD)','USD_m2','m2_cubiertos','m2_totales']]
```

```{python}
tabla_valores_promedio.head()
```

```{python}
# left join geopandasDataframe y valores promedio
merged_df = geodf.merge(tabla_valores_promedio,how='left',left_index=True,right_index=True) 
```

```{python}
# remplaza valores faltantes en barrio VILLA RIACHUELO
merged_df.fillna(0,inplace=True)
```

```{python}
merged_df['Precio(USD)'] = merged_df['Precio(USD)'].astype('int64')
merged_df['USD_m2'] = merged_df['USD_m2'].astype('int64')
merged_df['m2_cubiertos'] = merged_df['m2_cubiertos'].astype('int64')
merged_df['m2_totales'] = merged_df['m2_totales'].astype('int64')
```

```{python}
merged_df.head()
```

```{python}
fig = px.choropleth(merged_df,
                   geojson=merged_df.geometry,
                   locations=merged_df.index,
                   color="USD_m2",color_continuous_scale="Viridis",
                   projection="mercator",
                   labels={'BARRIO': 'Barrio','USD_m2':'Precio m2 en USD'})


fig.update_geos(fitbounds="locations", visible=False)
fig.update_layout(margin={"r":0,"t":50,"l":0,"b":0})

fig.update_layout(title_text='Precio promedio del metro cuadrado de departamentos por barrio <br>CABA (Marzo 2022)')

fig.update_layout(coloraxis_colorbar_x=0.8,coloraxis_colorbar_y=0.5)

fig.show()
```

